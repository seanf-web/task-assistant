<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>TASK Assistant</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>
<meta name="theme-color" content="#ffffff">
<style>
  :root{
    --radius:18px;
    --bg:#eef3f8; --surface:#fff; --surface-2:#f7fbff; --text:#0e1726; --muted:#5f6c80;
    --brand:#145078; --accent:#ff911f; --accent-2:#ffc91f; --border:#d9e2ec; --link:#0b63c6;
    --shadow:0 18px 36px rgba(20,80,120,.18); --shadow-soft:0 8px 20px rgba(19,33,58,.12);
    --bubble-bot:#fff; --bubble-border:#d9e2ec;
    --bubble-user-bg:linear-gradient(135deg,#ff911f,#ffc91f); --bubble-user-text:#fff; --bubble-user-border:transparent;
    --typing:#7e8aa3;
    --footer-h:76px; --keyboard-h:0px;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --surface:#0f1726; --surface-2:#0d1522; --text:#e6edf7; --muted:#a7b6c9;
    --brand:#8bd0ff; --accent:#ffb357; --accent-2:#ffd36a; --border:#223247; --link:#87c4ff;
    --bubble-bot:#121e33; --bubble-border:#2a3b55;
    --bubble-user-bg:#1f86ff; --bubble-user-text:#fff; --bubble-user-border:#0f5fc3;
    --typing:#a9c7ff; --shadow:0 20px 44px rgba(0,0,0,.45); --shadow-soft:0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text); padding:12px;
    padding-bottom:calc(12px + env(safe-area-inset-bottom));
    padding-left:calc(12px + env(safe-area-inset-left));
    padding-right:calc(12px + env(safe-area-inset-right));
    display:flex;align-items:center;justify-content:center;
    font-size: clamp(14px, 1.6vw, 16px);
  }
  a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
  .app{width:100%; max-width:560px; background:var(--surface); border:3px solid var(--accent); border-radius:18px; overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; height:100svh; height:100dvh;}
  .header{background:var(--surface-2); border-bottom:1px solid var(--border); padding:10px 96px 10px 56px; position:relative; text-align:center;}
  .badge{display:inline-block;background:var(--brand);color:#fff; padding:8px 14px;border-radius:999px;font:700 13px/1 "Nunito",sans-serif;cursor:pointer}
  .theme,.mic{position:absolute; top:8px; width:44px;height:44px;border:none;border-radius:999px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:var(--shadow-soft);cursor:pointer}
  .mic{right:56px} .theme{right:8px}
  .langbar{display:flex;gap:8px;justify-content:center;align-items:center;padding:8px;background:var(--surface-2);border-bottom:1px solid var(--border);flex-wrap:wrap}
  .lang-label{font:700 12px/1 "Nunito",sans-serif;color:#5f6c80}
  .lang-chip{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:999px;min-width:44px;min-height:36px;border:1px solid rgba(0,0,0,.08);background:#fff;font-weight:700;font-size:12px;pointer-events:none;opacity:.85}
  [data-theme="dark"] .lang-chip{background:#0f1926;border-color:#2b3a4e;color:#a7d7ff}
  .rail{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:10px;background:var(--surface-2);border-bottom:1px solid var(--border)}
  .chip{display:inline-flex;align-items:center;gap:8px;font-weight:600;font-size:12px;color:var(--brand);border:1px solid rgba(255,145,31,.35);background:#fff;border-radius:999px;padding:9px 12px;min-height:40px;box-shadow:var(--shadow-soft)}
  [data-theme="dark"] .chip{background:#0f1926;border-color:#2b3a4e;color:#a7d7ff}
  .chat{flex:1; overflow:auto; padding:14px; padding-bottom: calc(14px + var(--footer-h) + var(--keyboard-h)); scroll-behavior:smooth; background:
    radial-gradient(70% 100% at -10% -20%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 65%),
    radial-gradient(60% 90% at 110% 120%, rgba(255,255,255,.04) 0%, rgba(255,255,255,0) 60%),
    linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%);
  }
  .bubble{margin:12px 0;padding:12px 16px;border-radius:16px;line-height:1.45;border:1px solid var(--bubble-border);background:var(--bubble-bot);box-shadow:var(--shadow-soft);max-width:90%}
  .bubble.bot{margin-right:20%}
  .bubble.user{margin-left:20%;text-align:right;color:#fff;background:var(--bubble-user-bg);border:1px solid var(--bubble-user-border);border-radius:16px 16px 4px 16px}
  .typing{display:inline-flex;gap:6px;align-items:flex-end}
  .typing .dot{width:6px;height:6px;border-radius:50%;background:var(--typing);animation:bounce 1s infinite ease-in-out}
  .typing .dot:nth-child(2){animation-delay:.12s}.typing .dot:nth-child(3){animation-delay:.24s}
  @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-6px);opacity:1}}
  .footer{position:sticky;bottom:0;padding:12px;background:var(--surface-2);border-top:1px solid var(--border);transform:translateY(0);z-index:5}
  .row{display:flex;gap:10px;align-items:center}
  input[type="text"]{flex:1;padding:14px 16px;border:2px solid var(--border);border-radius:25px;font-size:16px;background:var(--surface);color:var(--text);caret-color:var(--accent)}
  input::placeholder{color:var(--muted)} input:focus{border-color:var(--accent)}
  .send{width:52px;height:52px;border:none;border-radius:50%;cursor:pointer;color:#222;font-size:18px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow-soft)}
  .status{margin-top:6px;text-align:center;font-size:11px;color:var(--muted)}
  .qrs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .qr,.qr-link{background:var(--surface-2);border:1px solid var(--border);border-radius:999px;padding:8px 10px;font-size:12px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
  .qr-link{text-decoration:none;color:inherit}
  .note{font-size:11px;color:var(--muted);margin-top:6px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
  .modal .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;min-width:280px;max-width:90%;box-shadow:var(--shadow)}
  .modal h4{font:700 14px "Nunito",sans-serif;margin-bottom:8px}
  .modal .row{margin-top:10px}.modal input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--surface-2)}
  .modal .btn{margin-top:10px;width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:var(--surface-2)}
  .modal .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#222;border:none}
  .admin-panel{position:fixed;inset:auto 12px 12px 12px;background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px;max-width:720px;display:none;z-index:9999}
  .btn{border:1px solid var(--border);background:var(--surface-2);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#222;border:none}
  .admin-panel textarea{width:100%;min-height:140px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);padding:8px}
</style>
</head>
<body>
  <main class="app" id="app">
    <header class="header">
      <div class="badge" id="scrollTopBtn" title="Scroll to top">TASK Assistant</div>
      <button class="mic" id="micBtn" title="Voice input">üéô</button>
      <button class="theme" id="themeToggle" title="Toggle theme">‚òº</button>
    </header>

    <div class="langbar" role="group" aria-label="Language">
      <span class="lang-label">Language / Idioma / Lang:</span>
      <span class="lang-chip" id="chipEN">EN</span>
      <span class="lang-chip" id="chipES">ES</span>
      <span class="lang-chip" id="chipHT">HT</span>
    </div>

    <nav class="rail" id="top-rail">
      <a class="chip" href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">üìç Address</a>
      <a class="chip" href="https://bycell.co/ddmtq" target="_blank" rel="noopener">üíº Jobs</a>
      <a class="chip" href="https://bycell.co/ddmtr" target="_blank" rel="noopener">üîî Alerts</a>
      <a class="chip" href="https://bycell.co/ddmtn" target="_blank" rel="noopener">üéì Training</a>
      <a class="chip" href="https://bycell.co/ddmui" target="_blank" rel="noopener">üìÑ Resume</a>
      <a class="chip" href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">üé• Interview Tips</a>
      <a class="chip" href="https://bycell.co/ddmua" target="_blank" rel="noopener">üß∞ Resources</a>
    </nav>

    <section class="chat" id="chat" role="log" aria-live="polite"></section>

    <footer class="footer" id="footer">
      <div class="row">
        <input id="box" type="text" placeholder="Type: training, jobs, hours, address, bus‚Ä¶" autocomplete="off" enterkeyhint="send"/>
        <button class="send" id="send">‚û§</button>
      </div>
      <div class="status" id="status">‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info!</div>
    </footer>
  </main>

  <!-- Admin (Ctrl+Alt+A) -->
  <div class="modal" id="pinModal" style="display:none">
    <div class="card">
      <h4>Enter admin PIN</h4>
      <div class="row"><input id="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="PIN"/></div>
      <button class="btn primary" id="pinSubmit">Unlock</button>
      <button class="btn" id="pinCancel">Cancel</button>
    </div>
  </div>

  <div class="admin-panel" id="adminPanel" style="display:none">
    <h3>Admin ‚Ä¢ TASK Assistant</h3>
    <div class="row">
      <button class="btn" id="exportCsv">Export CSV</button>
      <button class="btn" id="copySummary">Copy Summary</button>
      <button class="btn" id="clearLogs">Clear Logs</button>
      <button class="btn" id="loadLex" title="Paste JSON of extra keywords/responses">Load Keywords JSON</button>
      <button class="btn" id="closeAdmin" style="margin-left:auto">Close</button>
    </div>
    <div style="margin-top:10px">
      <strong style="font:700 13px Nunito, sans-serif">Missed / default queries</strong>
      <textarea id="missedBox" readonly></textarea>
    </div>
  </div>

  <div class="toast" id="toast" style="display:none"></div>

<script>
/* ---------- helpers & safety ---------- */
function stripDiacritics(s){
  try{ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch(e){ return s; }
}
function norm(s){ return (' ' + stripDiacritics(String(s||'')).toLowerCase() + ' '); }
function showToast(msg,ms=3200){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }

/* ---------- UI strings ---------- */
const UI = {
  en:{welcome:'üëã Hey there! I can help with training, jobs, appointments, hours, address, buses and more. Ask me anything.',
      quick:'Quick links:', mealHours:'Meals: Lunch Mon‚ÄìFri 10:30a‚Äì1:00p ‚Ä¢ Dinner Mon‚ÄìThu 3:30‚Äì5:00p',
      address:'72¬Ω Escher St, Trenton, NJ 08609', maps:'Open Google Maps',
      notFound:'I might not have that yet. For more help, visit:', site_home:'TASK website', site_services:'What we do',
      escalate:'Having trouble? Call me at', appt:'For appointments, use',
      no_walkins:'We do <strong>not</strong> take walk-ins. Please call to schedule. Same-day may be possible if you call first.',
      bi_note:'No caminatas / Pa san randevou',
      hello:'Hi! üëã How can I help today?', thanks:'You‚Äôre welcome! üòä Anything else I can do?', bye:'Take care! If you need to schedule, call (609) 337-1624.',
      q_call:'üìû Call now', q_text:'üí¨ Text me', q_next_forklift:'üõ†Ô∏è Next forklift class?', q_need_appt:'üìÖ Do I need an appointment?',
      q_call_jobs:'üìû Call jobs/training', q_see_jobs:'üîé Jobs site', q_see_training:'üéì Training site',
      ask_next_forklift:'When is the next forklift class?', ask_need_appt:'Do I need an appointment?'
  },
  es:{welcome:'üëã ¬°Hola! Puedo ayudarte con entrenamientos, empleos, citas, horarios, direcci√≥n, autobuses y m√°s. Preg√∫ntame lo que sea.',
      quick:'Enlaces r√°pidos:', mealHours:'Comidas: Almuerzo Lun‚ÄìVie 10:30‚Äì1:00 ‚Ä¢ Cena Lun‚ÄìJue 3:30‚Äì5:00',
      address:'72¬Ω Escher St, Trenton, NJ 08609', maps:'Abrir Google Maps',
      notFound:'Puede que a√∫n no tenga eso. Para m√°s ayuda, visita:', site_home:'Sitio de TASK', site_services:'Qu√© hacemos',
      escalate:'¬øCon problemas? Ll√°mame al', appt:'Para citas, usa',
      no_walkins:'No atendemos <strong>sin cita</strong>. Por favor llama para programar. A veces hay mismo d√≠a si llamas primero.',
      bi_note:'No caminatas / Pa san randevou',
      hello:'¬°Hola! üëã ¬øEn qu√© te puedo ayudar hoy?', thanks:'¬°Con gusto! üòä ¬øAlgo m√°s?', bye:'¬°Cu√≠date! Si necesitas una cita, llama al (609) 337-1624.',
      q_call:'üìû Llamar ahora', q_text:'üí¨ Enviarme un mensaje', q_next_forklift:'üõ†Ô∏è ¬øPr√≥xima clase de montacargas?', q_need_appt:'üìÖ ¬øNecesito cita?',
      q_call_jobs:'üìû Llamar empleo/entrenamiento', q_see_jobs:'üîé Empleos', q_see_training:'üéì Entrenamientos',
      ask_next_forklift:'¬øCu√°ndo es la pr√≥xima clase de montacargas?', ask_need_appt:'¬øNecesito una cita?'
  },
  ht:{welcome:'üëã Bonjou! Mwen ka ede ak f√≤masyon, travay, randevou, l√® yo, adr√®s, otobis, ak plis ank√≤. Mande m sa ou bezwen.',
      quick:'Lyen rapid:', mealHours:'Manje: Manje Maten Lun‚ÄìVandredi 10:30‚Äì1:00 ‚Ä¢ Asw√® Lun‚ÄìJedi 3:30‚Äì5:00',
      address:'72¬Ω Escher St, Trenton, NJ 08609', maps:'Louvri Google Maps',
      notFound:'M pa gen sa a ank√≤. Pou plis enf√≤masyon, vizite:', site_home:'Sit TASK', site_services:'Sa n ap f√®',
      escalate:'Gen difikilte? Rele mwen sou', appt:'Pou randevou, rele',
      no_walkins:'Nou pa pran <strong>san randevou</strong>. Tanpri rele pou pran randevou. Menm jou pafwa posib si w rele anvan.',
      bi_note:'No caminatas / Pa san randevou',
      hello:'Bonjou! üëã Kijan mwen ka ede w jodi a?', thanks:'Av√®k plezi! üòä Gen l√≤t bagay?', bye:'Pran swen t√®t ou! Si ou bezwen randevou, rele (609) 337-1624.',
      q_call:'üìû Rele kounye a', q_text:'üí¨ Voye t√®ks ban mwen', q_next_forklift:'üõ†Ô∏è Ki l√® pwochen klas forklift la?', q_need_appt:'üìÖ √àske mwen bezwen randevou?',
      q_call_jobs:'üìû Rele travay/f√≤masyon', q_see_jobs:'üîé Travay', q_see_training:'üéì F√≤masyon',
      ask_next_forklift:'Kil√® pwochen klas forklift la?', ask_need_appt:'√àske mwen bezwen randevou?'
  }
};

/* ---------- language detection (robust) ---------- */
let currentLang='en';
const chipEN=document.getElementById('chipEN'), chipES=document.getElementById('chipES'), chipHT=document.getElementById('chipHT');
function setLang(lang){ currentLang=(lang==='es'||lang==='ht')?'es'===lang?'es':'ht':'en';
  chipEN.style.opacity=currentLang==='en'?'1':'.5';
  chipES.style.opacity=currentLang==='es'?'1':'.5';
  chipHT.style.opacity=currentLang==='ht'?'1':'.5';
}
function detectLang(text){
  const s=norm(text);
  if(/ hola | gracias | cita | trabajo | empleo | donde | d[ou]nde esta | ubicacion | direccion | autobus | por favor | agendar | programar /.test(s)) return 'es';
  if(/ bonjou | bonswa | mesi | randevou | travay | kote | adre[s] | otobis | kijan | san randevou /.test(s)) return 'ht';
  return 'en';
}

/* ---------- theme ---------- */
const themeToggle=document.getElementById('themeToggle');
const THEME_KEY='task_theme';
function setTheme(mode){ document.documentElement.setAttribute('data-theme', mode); localStorage.setItem(THEME_KEY,mode); themeToggle.textContent=mode==='dark'?'‚òæ':'‚òº'; document.querySelector('meta[name="theme-color"]')?.setAttribute('content',mode==='dark'?'#0f1726':'#ffffff'); }
setTheme(localStorage.getItem(THEME_KEY)||'light'); themeToggle.addEventListener('click',()=>setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'));

/* ---------- DOM ---------- */
const chat=document.getElementById('chat'), box=document.getElementById('box'), sendBtn=document.getElementById('send'), statusEl=document.getElementById('status'), footer=document.getElementById('footer'), badge=document.getElementById('scrollTopBtn'), micBtn=document.getElementById('micBtn');
badge.addEventListener('click',()=> chat.scrollTo({top:0,behavior:'smooth'}));
function addUser(t){ const el=document.createElement('div'); el.className='bubble user'; el.textContent=t; chat.appendChild(el); el.scrollIntoView({block:'end',behavior:'smooth'}); }
function addBot(html){ const el=document.createElement('div'); el.className='bubble bot'; el.innerHTML=html; chat.appendChild(el); el.scrollIntoView({block:'end',behavior:'smooth'}); }
function typing(on=true){ const id='typing'; if(on){ const el=document.createElement('div'); el.id=id; el.className='bubble bot'; el.innerHTML=`<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`; chat.appendChild(el);}else{document.getElementById(id)?.remove();} chat.scrollTop=chat.scrollHeight; }

/* ---------- phones/links ---------- */
const TEL_APPT='tel:6093371624', TEL_JOBS_A='tel:6096976166', TEL_JOBS_B='tel:6096976215', SMS_ME='sms:16096976214?body=Hi%20this%20is%20%5Bname%5D%20from%20TASK';
function qrLink(label,href){ const a=document.createElement('a'); a.className='qr-link'; a.href=href; a.textContent=label; a.rel='noopener'; return a; }
function qrBtn(label,cb){ const b=document.createElement('button'); b.className='qr'; b.type='button'; b.textContent=label; b.addEventListener('click',cb); return b; }
function qrSet(o){ const wrap=document.createElement('div'); wrap.className='qrs';
  if(o.callAppt)wrap.appendChild(qrLink(UI[currentLang].q_call,TEL_APPT));
  if(o.textMe)wrap.appendChild(qrLink(UI[currentLang].q_text,SMS_ME));
  if(o.nextFork)wrap.appendChild(qrBtn(UI[currentLang].q_next_forklift,()=>handle(UI[currentLang].ask_next_forklift)));
  if(o.needAppt)wrap.appendChild(qrBtn(UI[currentLang].q_need_appt,()=>handle(UI[currentLang].ask_need_appt)));
  if(o.callJobs)wrap.appendChild(qrLink(UI[currentLang].q_call_jobs,TEL_JOBS_A));
  if(o.jobsSite)wrap.appendChild(qrLink(UI[currentLang].q_see_jobs,'https://bycell.co/ddmtq'));
  if(o.trainingSite)wrap.appendChild(qrLink(UI[currentLang].q_see_training,'https://bycell.co/ddmtn'));
  return wrap;
}

/* ---------- keyword bank (normalized) ---------- */
const BANK_RAW={
  greeting:['hi','hello','hey','hola','bonjou','bonswa','bonjour','salut'],
  thanks:['thanks','thank you','gracias','merci','mesi','meci','thx','ty'],
  goodbye:['bye','goodbye','adios','adi√≥s','ciao','nos vemos','na we','n a w√®','later','see ya'],
  jobs:['job','jobs','employment','hiring','apply','application','position','work','career','empleo','trabajo','puestos','trabajos','contratando','trabajar','travay'],
  training:['training','trainings','program','programs','class','classes','course','courses','certification','certifications','academy','entrenamiento','entrenamientos','programa','programas','clase','clases','curso','cursos','certificacion','certificaciones','f√≤masyon','kour','kou','sertifikasyon'],
  employment_services:['employment services','job services','workforce','career services','career center','servicios de empleo','servicios laborales','centro de empleo','s√®vis travay','s√®vis anplwa','career help','task employment'],
  housing:['homeless','shelter','housing','code blue','warming center','sin hogar','albergue','refugio','kote pou d√≤mi','abri'],
  resume:['resume','cv','cover letter','template','write my resume','help resume','build resume','curriculum','curriculum vitae','hoja de vida','curr√≠culum'],
  culinary:['culinary','kitchen training','emilio','academy','cooking program','culinaria','academia emilio','kou kwizin','chef'],
  forklift:['forklift','warehouse license','osha','certification','montacargas','forklift training','sertifikasyon'],
  case_mgmt:['case management','case manager','caseworker','case worker','social worker','manejo de casos','gestion de casos','trabajador social','jesyon ka','travay√® sosyal'],
  idhelp:['id help','state id','identification','photo id','non-driver id','non driver id','identificacion','identificaci√≥n','tarjeta de id','kat idantite','idantite','kat id'],
  appointment:[
    'appointment','appt','apointment','appoint','make an appointment','set an appointment','book','booking','schedule','scheduling','rsvp','register','sign up','enroll','enrollment','pre-register','intake','orientation','meeting','consultation','consult','callback','call back','availability','available time','time slot','next opening','next available',
    'walk in','walk-in','walkins','drop in','drop-in','come in','come by','same day','same-day','today','tomorrow','this week','asap','soon','right now','need an appointment','do i need an appointment','check in',
    'cita','sin cita','sin cita previa','agendar','programar','reservar','reserva','registrarme','inscribirme','inscripcion','orientacion','ingreso','entrevista','horario disponible','proxima cita','mismo dia','hoy','manana','puedo pasar hoy','donde saco cita',
    'randevou','pran randevou','fe randevou','rez√®ve','ore','le ki disponib','pwochen plas','san randevou','menm jou','jodi a','demen','kounye a','mwen bezwen randevou'
  ],
  hours:['hours','time','open','close','lunch','dinner','meal','horario','horas','le','l√®','schedule'],
  location:['address','location','map','where','direccion','direcci√≥n','ubicacion','ubicaci√≥n','donde','donde esta','donde queda','como llegar','kote','ki kote','adr√®s','adres','mapa'],
  transit:['bus','nj transit','route','ticket','fare','train','planner','autobus','autob√∫s','tren','otobis','bus pass'],
  resources:['benefits','snap','ebt','wic','tanf','ssi','ssdi','utilities','pseg','rent','legal','expungement','rehab','recovery','counseling','mental health','beneficios','servicios','asistencia','benefis','ede','phones','cell phone']
};
const BANK = Object.fromEntries(Object.entries(BANK_RAW).map(([k,arr])=>[k,arr.map(w=>norm(w))]));

/* ---------- intent finder (greeting/thanks/bye first) ---------- */
function findIntents(text){
  const t=norm(text);
  const hits=new Set();

  // conversational first
  if(/\b(hi|hello|hey|hola|bonjou|bonswa|bonjour|salut)\b/.test(stripDiacritics(text).toLowerCase())) hits.add('greeting');
  if(/\b(thanks|thank you|gracias|merci|mesi|meci|thx|ty)\b/.test(stripDiacritics(text).toLowerCase())) hits.add('thanks');
  if(/\b(bye|goodbye|adios|adi√≥s|ciao|nos vemos|na we|n a we|later|see ya)\b/.test(stripDiacritics(text).toLowerCase())) hits.add('goodbye');

  // bank match (accent-insensitive, word-ish match)
  for(const [intent, words] of Object.entries(BANK)){
    if(['greeting','thanks','goodbye'].includes(intent)) continue;
    for(const w of words){ if(t.indexOf(w)>=0){ hits.add(intent); break; } }
  }

  // escalate complex combos
  if(hits.has('case_mgmt')||hits.has('idhelp')) hits.add('appointment');
  return [...hits];
}

/* ---------- response builder ---------- */
function section(title,body){ return `<div style="margin-bottom:10px"><strong>${title}</strong><br>${body}</div>`; }
function replyFor(intents, rawText){
  const order=['greeting','thanks','goodbye','appointment','case_mgmt','idhelp','jobs','training','employment_services','housing','resume','culinary','forklift','hours','location','transit','resources'];
  intents.sort((a,b)=>order.indexOf(a)-order.indexOf(b));

  const blocks=[];
  let addApptQR=false, addJobsQR=false;
  const wantsSameDay = /(same[\s-]?day|today|right now|asap|hoy|jodi a)/i.test(rawText);

  if(intents.includes('greeting')) blocks.push(section('üëã', UI[currentLang].hello));
  if(intents.includes('thanks'))   blocks.push(section('üòä', UI[currentLang].thanks));
  if(intents.includes('goodbye'))  blocks.push(section('üëã', UI[currentLang].bye));

  if(intents.includes('appointment')||intents.includes('case_mgmt')||intents.includes('idhelp')){
    let msg = `Best way: call <a href="tel:6093371624">(609) 337-1624</a>.<br>${UI[currentLang].no_walkins}<div class="note">${UI[currentLang].bi_note}</div>`;
    if(wantsSameDay) msg += `<br>Same-day may be possible ‚Äî please call first: <a href="tel:6093371624">(609) 337-1624</a>.`;
    msg += `<br>If you can‚Äôt get through, call me at <a href="tel:6096976215">(609) 697-6215</a> or text <a href="sms:16096976214">(609) 697-6214</a>.`;
    blocks.push(section('üìÖ Make / Check an Appointment', msg));
    addApptQR=true;
  }
  if(intents.includes('jobs')){
    blocks.push(section('üíº Jobs', `
<a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Open positions (Mercer County)</a><br>
Sign up for alerts: <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Job Alerts</a><br>
Need help with jobs or training? Call <a href="tel:6096976166">(609) 697-6166</a> or <a href="tel:6096976215">(609) 697-6215</a>.`));
    addJobsQR=true;
  }
  if(intents.includes('training')){
    blocks.push(section('üéì Training', `Browse training & apply: <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a><br>Questions? Call <a href="tel:6096976166">(609) 697-6166</a> or <a href="tel:6096976215">(609) 697-6215</a>.`));
    addJobsQR=true;
  }
  if(intents.includes('employment_services')){
    blocks.push(section('üß∞ Employment Services', `We can help with job search, applications, resume, and certifications.<br>Start here: <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Jobs</a> ‚Ä¢ <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a><br>Talk to a person: <a href="tel:6096976166">(609) 697-6166</a> or <a href="tel:6096976215">(609) 697-6215</a>.`));
    addJobsQR=true;
  }
  if(intents.includes('housing')){
    blocks.push(section('üè† Housing / Shelter', `For Code Blue and shelter info, start here:<br><a href="https://bycell.co/ddmua" target="_blank" rel="noopener">Resources</a><br>If you‚Äôre stuck, call me at <a href="tel:6096976215">(609) 697-6215</a> or text <a href="sms:16096976214">(609) 697-6214</a>.`));
  }
  if(intents.includes('resume')){
    blocks.push(section('üìÑ Resume help', `Templates & guidance: <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume</a><br>For 1-on-1 help, call <a href="tel:6093371624">(609) 337-1624</a>.`));
  }
  if(intents.includes('culinary')){
    blocks.push(section('üë®‚Äçüç≥ Emilio Culinary Academy', `10-week culinary training. Apply/details: <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a><br>Ask about start dates/interviews: <a href="tel:6093371624">(
