<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>TASK Assistant</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>
  <meta name="theme-color" content="#ffffff">

  <style>
    :root{
      --radius:18px;

      /* Light */
      --bg:#eef3f8; --surface:#ffffff; --surface-2:#f7fbff; --text:#0e1726; --muted:#5f6c80;
      --brand:#145078; --accent:#ff911f; --accent-2:#ffc91f; --border:#d9e2ec; --link:#0b63c6;
      --shadow:0 18px 36px rgba(20,80,120,.18); --shadow-soft:0 8px 20px rgba(19,33,58,.12);
      --bubble-bot:#ffffff; --bubble-border:#d9e2ec;
      --bubble-user-bg:linear-gradient(135deg,#ff911f,#ffc91f); --bubble-user-text:#fff; --bubble-user-border:transparent;
      --typing:#7e8aa3;

      /* dynamic (JS updates) */
      --footer-h:76px;  /* measured footer height */
      --keyboard-h:0px; /* measured keyboard overlap */
    }

    [data-theme="dark"]{
      --bg:#0b1220; --surface:#0f1726; --surface-2:#0d1522; --text:#e6edf7; --muted:#a7b6c9;
      --brand:#8bd0ff; --accent:#ffb357; --accent-2:#ffd36a; --border:#223247; --link:#87c4ff;
      --bubble-bot:#121e33; --bubble-border:#2a3b55;
      --bubble-user-bg:#1f86ff; --bubble-user-text:#ffffff; --bubble-user-border:#0f5fc3;
      --typing:#a9c7ff; --shadow:0 20px 44px rgba(0,0,0,.45); --shadow-soft:0 10px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      padding:12px;
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
      padding-left:calc(12px + env(safe-area-inset-left));
      padding-right:calc(12px + env(safe-area-inset-right));
      display:flex;align-items:center;justify-content:center;
      font-size: clamp(14px, 1.6vw, 16px);
    }
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .bubble{ font-size: clamp(13px, 1.4vw, 15px); }
    .badge{ font-size: clamp(12px, 1.2vw, 13px); }
    :focus-visible { outline:3px solid #87c4ff; outline-offset:2px; }
    @media (prefers-reduced-motion: reduce){ *{ animation:none!important; transition:none!important; scroll-behavior:auto!important; } }

    /* APP ‚Äî use dvh so viewport shrinks when keyboard opens */
    .app{
      width:100%; max-width:560px; background:var(--surface);
      border:3px solid var(--accent); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
      display:flex; flex-direction:column;
      height:100svh;  /* fallback */
      height:100dvh;  /* dynamic viewport (iOS-friendly) */
    }
    @media (max-width:420px){ .app{ max-width:100% } }

    .header{
      background:var(--surface-2); border-bottom:1px solid var(--border);
      padding:10px 46px; position:relative; text-align:center;
      transition:padding .15s ease;
    }
    .badge{ display:inline-block;background:var(--brand);color:#fff;padding:8px 14px;border-radius:999px;font:700 13px/1 "Nunito",sans-serif;letter-spacing:.2px;box-shadow:var(--shadow-soft); }
    .theme,.mic{
      position:absolute; top:8px; border:none; border-radius:999px; cursor:pointer;
      width:44px;height:44px; min-width:44px;min-height:44px; display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#222; font-weight:700; box-shadow:var(--shadow-soft); touch-action:manipulation;
    }
    .mic{right:56px} .theme{right:8px}
    .theme:active,.mic:active{ transform:scale(.98); }

    .langbar{ display:flex;gap:8px;justify-content:center;align-items:center;padding:8px;background:var(--surface-2);border-bottom:1px solid var(--border);flex-wrap:wrap; transition:max-height .15s ease, opacity .15s ease; }
    .lang-label{font:700 12px/1 "Nunito",sans-serif;color:var(--muted)}
    .lang-chip{ display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:999px;cursor:pointer;min-width:44px;min-height:36px;border:1px solid rgba(0,0,0,.08);background:#fff;font-weight:700;font-size:12px; }
    [data-theme="dark"] .lang-chip{background:#0f1926;border-color:#2b3a4e;color:#a7d7ff}

    .rail{ display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:10px;background:var(--surface-2);border-bottom:1px solid var(--border); transition:max-height .15s ease, opacity .15s ease; }
    .chip{ display:inline-flex;align-items:center;gap:8px;font-weight:600;font-size:12px;color:var(--brand);border:1px solid rgba(255,145,31,.35);background:#fff;border-radius:999px;padding:9px 12px;min-height:40px;min-width:44px;box-shadow:var(--shadow-soft)}
    [data-theme="dark"] .chip{background:#0f1926;border-color:#2b3a4e;color:#a7d7ff}

    .chat{
      flex:1; overflow:auto; padding:14px;
      /* Keep space for the footer so last bubble isn't hidden */
      padding-bottom: calc(14px + var(--footer-h) + var(--keyboard-h));
      scroll-behavior:smooth; overscroll-behavior:contain;
      background:
        radial-gradient(70% 100% at -10% -20%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 65%),
        radial-gradient(60% 90% at 110% 120%, rgba(255,255,255,.04) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%);
    }
    .bubble{
      margin:12px 0; padding:12px 16px; border-radius:16px; line-height:1.45;
      border:1px solid var(--bubble-border); background:var(--bubble-bot); color:var(--text);
      box-shadow:var(--shadow-soft); max-width:90%;
    }
    .bubble.bot{margin-right:20%}
    .bubble.user{ position:relative; margin-left:20%; text-align:right; color:var(--bubble-user-text); background:var(--bubble-user-bg); border:1px solid var(--bubble-user-border); border-radius:16px 16px 4px 16px; max-width:90%; }
    [data-theme="dark"] .bubble.user::after, [data-theme="dark"] .bubble.user::before{ content:""; position:absolute; bottom:16px; right:-11px; width:16px;height:14px; clip-path:polygon(100% 50%,0 0,0 100%); }
    [data-theme="dark"] .bubble.user::after{ background:var(--bubble-user-border) }
    [data-theme="dark"] .bubble.user::before{ right:-9px; bottom:17px; width:14px; height:12px; background:var(--bubble-user-bg) }

    .typing{display:inline-flex;gap:6px;align-items:flex-end}
    .typing .dot{width:6px;height:6px;border-radius:50%;background:var(--typing);animation:bounce 1s infinite ease-in-out;will-change:transform,opacity}
    .typing .dot:nth-child(2){animation-delay:.12s} .typing .dot:nth-child(3){animation-delay:.24s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-6px);opacity:1}}

    /* FOOTER ‚Äî pinned to bottom; JS lifts it above keyboard */
    .footer{
      position:sticky; bottom:0;
      padding:12px; background:var(--surface-2); border-top:1px solid var(--border);
      transform: translateY(0); transition: transform .15s ease;
      z-index:5;
    }
    .row{display:flex;gap:10px;align-items:center}
    input[type="text"]{
      flex:1; padding:14px 16px; border:2px solid var(--border); border-radius:25px;
      font-size:16px; outline:none; background:var(--surface); color:var(--text); caret-color:var(--accent);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.06);
    }
    input::placeholder{color:var(--muted)}
    input:focus{border-color:var(--accent)}
    .send{ width:52px;height:52px;border:none;border-radius:50%;cursor:pointer;color:#222;font-size:18px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow-soft) }
    .status{ margin-top:6px; text-align:center; font-size:11px; color:var(--muted) }
    .pill{ display:inline-block; padding:.5px 8px; border-radius:999px; background:rgba(25,169,116,.1); color:#19a974; font-weight:700; font-size:11px }

    /* Collapse top bars while keyboard is open to reveal input on small phones */
    body.kb .langbar, body.kb .rail { max-height:0; opacity:0; overflow:hidden; padding:0; border:0; }
    body.kb .header{ padding:6px 46px; }
  </style>
</head>
<body>
  <main class="app" id="app">
    <header class="header">
      <div class="badge" aria-label="TASK Assistant">TASK Assistant</div>
      <button class="theme" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">‚òº</button>
    </header>

    <div class="langbar" id="langbar" role="group" aria-label="Language selection">
      <span class="lang-label">Language / Idioma / Lang:</span>
      <button class="lang-chip" data-lang="en">EN</button>
      <button class="lang-chip" data-lang="es">ES</button>
      <button class="lang-chip" data-lang="ht">HT</button>
    </div>

    <nav class="rail" id="top-rail">
      <a class="chip" id="chip-address" href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">üìç Address</a>
      <a class="chip" id="chip-jobs" href="https://bycell.co/ddmtq" target="_blank" rel="noopener">üíº Jobs</a>
      <a class="chip" id="chip-alerts" href="https://bycell.co/ddmtr" target="_blank" rel="noopener">üîî Alerts</a>
      <a class="chip" id="chip-training" href="https://bycell.co/ddmtn" target="_blank" rel="noopener">üéì Training</a>
      <a class="chip" id="chip-resume" href="https://bycell.co/ddmui" target="_blank" rel="noopener">üìÑ Resume</a>
      <a class="chip" id="chip-tips" href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">üé• Interview Tips</a>
      <a class="chip" id="chip-resources" href="https://bycell.co/ddmua" target="_blank" rel="noopener">üß∞ Resources</a>
    </nav>

    <section class="chat" id="chat" role="log" aria-live="polite" aria-atomic="false"></section>

    <footer class="footer" id="footer">
      <div class="row">
        <input id="box" type="text" placeholder="Type: training, jobs, hours, address, bus‚Ä¶" autocomplete="off" enterkeyhint="send" aria-label="Type your message"/>
        <button class="send" id="send" aria-label="Send">‚û§</button>
      </div>
      <div class="status" id="status">‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info!</div>
    </footer>
  </main>

  <script>
    /* ======= Minimal i18n (keep English text; add more if you want) ======= */
    const L = {
      en: {
        welcome: 'üëã Welcome! Use keywords like <em>training</em>, <em>jobs</em>, <em>hours</em>, <em>address</em>, or <em>bus</em>.',
        quick: 'Quick links:',
        asked: 'You asked about',
        mealHours: 'Meals: Lunch Mon‚ÄìFri 10:30a‚Äì1:00p ‚Ä¢ Dinner Mon‚ÄìThu 3:30‚Äì5:00p',
        address: '72¬Ω Escher St, Trenton, NJ 08609',
        maps: 'Open Google Maps',
        notFound: 'I might not have that yet. For more help, visit:',
        site_home: 'TASK website', site_services: 'What we do',
        escalate: 'Having trouble? Call me at',
        appt: 'For appointments, use',
      }
    };
    let currentLang = 'en';
    function t(k){ return L[currentLang][k]; }

    /* ======= Theme ======= */
    const themeToggle = document.getElementById('themeToggle');
    const THEME_KEY = 'task_theme';
    function setTheme(mode){
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem(THEME_KEY, mode);
      themeToggle.textContent = mode==='dark' ? '‚òæ' : '‚òº';
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.setAttribute('content', mode==='dark' ? '#0f1726' : '#ffffff');
    }
    setTheme(localStorage.getItem(THEME_KEY)||'light');
    themeToggle.addEventListener('click', ()=> setTheme(
      document.documentElement.getAttribute('data-theme')==='dark' ? 'light':'dark'
    ));

    /* ======= DOM refs ======= */
    const chat = document.getElementById('chat');
    const box  = document.getElementById('box');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const footer = document.getElementById('footer');

    /* ======= Chat helpers ======= */
    function addUser(text){
      const el = document.createElement('div');
      el.className = 'bubble user';
      el.textContent = text;
      chat.appendChild(el);
      el.scrollIntoView({behavior:'smooth',block:'end'});
    }
    function addBot(html){
      const el = document.createElement('div');
      el.className = 'bubble bot';
      el.innerHTML = html;
      chat.appendChild(el);
      el.scrollIntoView({behavior:'smooth',block:'end'});
    }
    function typing(on=true){
      const id='typing';
      if(on){
        const el=document.createElement('div');
        el.id=id; el.className='bubble bot';
        el.innerHTML = `<div class="typing">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>`;
        chat.appendChild(el);
      }else{
        const t=document.getElementById(id); if(t) t.remove();
      }
      chat.scrollTop = chat.scrollHeight;
    }

    /* ======= Multi-intent understanding ======= */
    const PHONE_ME = '<a href="tel:609-697-6215">(609) 697-6215</a>';
    const PHONE_APPT = '<a href="tel:609-337-1624">(609) 337-1624</a>';

    // Keywords per intent
    const BANK = {
      jobs:       ['job','jobs','employment','hiring','apply','application','position','work','career'],
      housing:    ['homeless','shelter','housing','code blue','warming center'],
      resume:     ['resume','cv','cover letter','template','write my resume','help resume','build resume'],
      culinary:   ['culinary','kitchen training','emilio','academy','cooking program'],
      forklift:   ['forklift','warehouse license','oscha','osha'],
      appointment:['appointment','book','schedule','rsvp','register','make an appointment'],
      hours:      ['hours','time','open','close','lunch','dinner','meal','when'],
      location:   ['address','location','map','where'],
      transit:    ['bus','nj transit','route','ticket','fare','train','planner'],
      resources:  ['id','state id','birth certificate','mail','benefits','snap','ebt','wic','tanf','ssi','ssdi','utilities','pseg','rent','shelter','legal','expungement','rehab','recovery','counseling','mental health'],
      angry:      ['angry','mad','pissed','upset','annoyed','frustrated','useless','not helpful','this sucks','wtf','bullshit','help me','can‚Äôt find','cant find','lost','confusing','not working','broken']
    };

    function findIntents(text){
      const t = text.toLowerCase();
      const hits = new Set();
      // simple contains match
      for(const [intent, words] of Object.entries(BANK)){
        for(const w of words){ if(t.includes(w)){ hits.add(intent); break; } }
      }
      // grammar helpers
      if(/\b(i\s+need|i\s+want).+job/.test(t)) hits.add('jobs');
      if(/\b(i\s+am|i'm)\s+homeless\b/.test(t)) hits.add('housing');
      if(/forklift/.test(t) && /(next|when)/.test(t)) hits.add('forklift');
      if(/appointment|schedule|book/.test(t)) hits.add('appointment');
      return [...hits];
    }

    function section(title, body){
      return `<div style="margin-bottom:10px"><strong>${title}</strong><br>${body}</div>`;
    }

    function replyFor(intents){
      // always keep a predictable order
      const order = ['jobs','housing','resume','culinary','forklift','hours','location','transit','resources','appointment','angry'];
      intents.sort((a,b)=>order.indexOf(a)-order.indexOf(b));

      if(intents.length===0){
        return `<strong>üîó ${t('notFound')}</strong><br>
          <a href="https://trentonsoupkitchen.org/" target="_blank" rel="noopener">${t('site_home')}</a> ‚Ä¢
          <a href="https://trentonsoupkitchen.org/what-we-do/" target="_blank" rel="noopener">${t('site_services')}</a>`;
      }

      const blocks = [];
      for(const key of intents){
        if(key==='jobs'){
          blocks.push(section('üíº Jobs',
            `<a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Open positions (Mercer County)</a><br>
             Sign up for alerts: <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Job Alerts</a>`));
        }
        if(key==='housing'){
          blocks.push(section('üè† Housing / Shelter',
            `If you need immediate shelter or Code Blue info, ask for resources:<br>
             <a href="https://bycell.co/ddmua" target="_blank" rel="noopener">Resources</a><br>
             Having trouble? Call me at ${PHONE_ME}.`));
        }
        if(key==='resume'){
          blocks.push(section('üìÑ Resume help',
            `Templates & guidance: <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume</a><br>
             For 1-on-1 help, call ${PHONE_APPT}.`));
        }
        if(key==='culinary'){
          blocks.push(section('üë®‚Äçüç≥ Emilio Culinary Academy',
            `10-week culinary training. Details & apply here: <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a><br>
             Appointments/questions: ${PHONE_APPT}.`));
        }
        if(key==='forklift'){
          blocks.push(section('üõ†Ô∏è Forklift Certification',
            `Check dates/availability on the Training page: <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a><br>
             You can call ${PHONE_APPT} to confirm the next class and whether you need an appointment.`));
        }
        if(key==='hours'){
          blocks.push(section('üïí Hours', t('mealHours')));
        }
        if(key==='location'){
          blocks.push(section('üìç Address',
            `${t('address')}<br><a href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">${t('maps')}</a>`));
        }
        if(key==='transit'){
          blocks.push(section('üöå Transit',
            `<a href="https://www.njtransit.com/trip-planner-to" target="_blank" rel="noopener">NJ Transit Trip Planner</a> ‚Ä¢ 1-973-275-5555<br>
             Destination: 72¬Ω Escher St, Trenton.`));
        }
        if(key==='resources'){
          blocks.push(section('üß∞ Resources',
            `IDs, benefits, housing, legal, phones, and more:<br>
             <a href="https://bycell.co/ddmua" target="_blank" rel="noopener">Resource list</a>`));
        }
        if(key==='appointment'){
          blocks.push(section('üìÖ Appointments', `Please call ${PHONE_APPT} (best during lunch hours).`));
        }
        if(key==='angry'){
          blocks.push(section('üôè Let me help',
            `${t('escalate')} ${PHONE_ME}.<br>${t('appt')}: ${PHONE_APPT}.`));
        }
      }
      return blocks.join('<hr style="border:none;height:8px;background:transparent">');
    }

    function handle(text){
      if(!text) return;
      addUser(text);
      statusEl.textContent='ü§ñ Thinking‚Ä¶';
      typing(true);

      const intents = findIntents(text);

      setTimeout(()=>{
        typing(false);
        addBot(replyFor(intents));
        statusEl.textContent='‚úÖ Answered!';
        setTimeout(()=> statusEl.textContent='‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info!', 1200);
      }, 260);
    }

    function send(){
      const text = (box.value || '').trim();
      if(!text) return;
      box.value = ''; box.blur(); // blur to reduce stuck keyboards on older phones
      handle(text);
      setTimeout(()=>box.focus(), 100); // refocus so user keeps typing
    }

    // Initial welcome
    addBot(`üü° <strong>${t('welcome')}</strong><br><br>
            ${t('quick')} <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a> ‚Ä¢
            <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Jobs</a> ‚Ä¢
            <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Alerts</a>`);

    sendBtn.addEventListener('click', send);
    box.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); } });

    /* ========= MOBILE KEYBOARD FIX =========
       Works on iOS Safari + Android/Budget phones.
       - Uses visualViewport when available
       - Fallback: when input focused, pin footer as fixed to viewport
    =======================================*/
    function measureFooter(){
      const h = footer.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--footer-h', `${Math.round(h)}px`);
    }
    measureFooter();
    addEventListener('resize', measureFooter);

    (function keyboardAware(){
      const vv = window.visualViewport;
      const useVV = !!vv && typeof vv.height === 'number';

      function setKeyboard(px){
        document.documentElement.style.setProperty('--keyboard-h', `${Math.max(0, Math.round(px))}px`);
        // if keyboard is showing, collapse top bars to keep input visible
        document.body.classList.toggle('kb', px > 0);
        // keep last message in view
        chat.lastElementChild?.scrollIntoView({block:'end'});
      }

      if(useVV){
        const adjust = () => {
          // Layout viewport height
          const layoutH = document.documentElement.clientHeight;
          // How much of layout viewport is obscured by the keyboard
          const overlap = Math.max(0, layoutH - (vv.height + vv.offsetTop));
          // Move footer up by overlap (CSS uses --keyboard-h for padding)
          footer.style.transform = `translateY(${-overlap}px)`;
          setKeyboard(overlap);
          measureFooter();
        };
        vv.addEventListener('resize', adjust);
        vv.addEventListener('scroll', adjust);
        box.addEventListener('focus', ()=>{ requestAnimationFrame(adjust); });
        box.addEventListener('blur',  ()=>{ setKeyboard(0); footer.style.transform='translateY(0)'; });
      } else {
        // Fallback for very old browsers / some government phones
        function pinFooter(pinned){
          if(pinned){
            const rect = document.getElementById('app').getBoundingClientRect();
            footer.style.position='fixed';
            footer.style.left = rect.left+'px';
            footer.style.right = (window.innerWidth-rect.right)+'px';
            footer.style.bottom = 'env(safe-area-inset-bottom)';
            footer.style.width = rect.width+'px';
            document.body.classList.add('kb');
          }else{
            footer.style.position='sticky';
            footer.style.left = footer.style.right = footer.style.bottom = footer.style.width = '';
            document.body.classList.remove('kb');
          }
          measureFooter();
          chat.lastElementChild?.scrollIntoView({block:'end'});
        }
        box.addEventListener('focus', ()=> pinFooter(true));
        box.addEventListener('blur',  ()=> pinFooter(false));
      }

      // Extra nudge for iOS AutoFill bar
      box.addEventListener('focus', ()=>{
        setTimeout(()=>{
          window.scrollTo(0, document.body.scrollHeight);
          chat.lastElementChild?.scrollIntoView({block:'end'});
        }, 50);
      });
    })();
  </script>
</body>
</html>
