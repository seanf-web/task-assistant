<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TASK Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    /* =========================
       Design Tokens / Themes
    ==========================*/
    :root{
      --radius:18px;

      /* Light */
      --bg:#eef3f8;
      --surface:#ffffff;
      --surface-2:#f7fbff;
      --text:#0e1726;
      --muted:#5f6c80;
      --brand:#145078;
      --accent:#ff911f;
      --accent-2:#ffc91f;
      --border:#d9e2ec;
      --link:#0b63c6;
      --shadow:0 18px 36px rgba(20,80,120,.18);
      --shadow-soft:0 8px 20px rgba(19,33,58,.12);

      --bubble-bot:#ffffff;
      --bubble-border:#d9e2ec;

      --bubble-user-bg:linear-gradient(135deg,var(--accent),var(--accent-2));
      --bubble-user-text:#fff;
      --bubble-user-border:transparent;

      --typing:#7e8aa3;
    }

    [data-theme="dark"]{
      --bg:#0b1220;
      --surface:#0f1726;
      --surface-2:#0d1522;
      --text:#e6edf7;
      --muted:#a7b6c9;
      --brand:#8bd0ff;
      --accent:#ffb357;
      --accent-2:#ffd36a;
      --border:#223247;
      --link:#87c4ff;

      --bubble-bot:#121e33;
      --bubble-border:#2a3b55;

      --bubble-user-bg:#1f86ff;
      --bubble-user-text:#ffffff;
      --bubble-user-border:#0f5fc3;

      --typing:#a9c7ff;
      --shadow:0 20px 44px rgba(0,0,0,.45);
      --shadow-soft:0 10px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      padding:12px;
    }
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}

    /* =========================
       App Shell / Responsive
    ==========================*/
    .app{
      width:100%;
      max-width:560px;               /* wider for desktop */
      background:var(--surface);
      border:3px solid var(--accent);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:min(92vh,860px);    /* mobile+desktop friendly */
    }

    @media (max-width:420px){
      .app{min-height:92vh; max-width:100%}
    }

    /* Header */
    .header{
      background:var(--surface-2);
      border-bottom:1px solid var(--border);
      padding:10px 46px;
      position:relative;text-align:center;
    }
    .badge{
      display:inline-block;background:var(--brand);color:#fff;
      padding:8px 14px;border-radius:999px;
      font:700 13px/1 "Nunito",sans-serif;letter-spacing:.2px;
      box-shadow:var(--shadow-soft);
    }
    .theme, .mic{
      position:absolute;top:8px;border:none;border-radius:999px;cursor:pointer;
      width:34px;height:34px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#222;font-weight:700;box-shadow:var(--shadow-soft);
    }
    .mic{right:52px}
    .theme{right:8px}

    /* Language prompt bar */
    .langbar{
      display:flex;gap:8px;justify-content:center;align-items:center;
      padding:8px;background:var(--surface-2);border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }
    .lang-label{font:700 12px/1 "Nunito",sans-serif;color:var(--muted)}
    .lang-chip{
      display:inline-block;padding:6px 9px;border-radius:999px;cursor:pointer;
      border:1px solid rgba(0,0,0,.08);background:#fff;font-weight:700;font-size:12px;
    }
    [data-theme="dark"] .lang-chip{background:#0f1926;border-color:#2b3a4e;color:#a7d7ff}

    /* Quick links rail */
    .rail{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding:10px;background:var(--surface-2);border-bottom:1px solid var(--border);
    }
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:600;font-size:12px;color:var(--brand);
      border:1px solid rgba(255,145,31,.35);
      background:#fff;border-radius:999px;padding:7px 11px;
      box-shadow:var(--shadow-soft);
    }
    [data-theme="dark"] .chip{background:#0f1926;border-color:#2b3a4e;color:#a7d7ff}

    /* Chat region */
    .chat{
      flex:1;overflow:auto;padding:14px;scroll-behavior:smooth;
      background:
        radial-gradient(70% 100% at -10% -20%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 65%),
        radial-gradient(60% 90% at 110% 120%, rgba(255,255,255,.04) 0%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%);
    }
    .bubble{
      margin:12px 0;padding:12px 16px;border-radius:16px;
      font-size:14px;line-height:1.45;border:1px solid var(--bubble-border);
      background:var(--bubble-bot);color:var(--text);box-shadow:var(--shadow-soft);
      max-width:90%;
    }
    .bubble.bot{margin-right:20%}
    .bubble.user{
      position:relative;margin-left:20%;text-align:right;
      color:var(--bubble-user-text);
      background:var(--bubble-user-bg);
      border:1px solid var(--bubble-user-border);
      border-radius:16px 16px 4px 16px;max-width:90%;
    }
    /* User tail for dark mode */
    [data-theme="dark"] .bubble.user::after,
    [data-theme="dark"] .bubble.user::before{
      content:""; position:absolute; bottom:16px; right:-11px;
      width:16px;height:14px; clip-path:polygon(100% 50%,0 0,0 100%);
    }
    [data-theme="dark"] .bubble.user::after{ background:var(--bubble-user-border) }
    [data-theme="dark"] .bubble.user::before{ right:-9px;bottom:17px;width:14px;height:12px;background:var(--bubble-user-bg) }

    /* Typing */
    .typing{display:inline-flex;gap:6px;align-items:flex-end}
    .typing .dot{width:6px;height:6px;border-radius:50%;background:var(--typing);
      animation:bounce 1s infinite ease-in-out;will-change:transform,opacity;}
    .typing .dot:nth-child(2){animation-delay:.12s}
    .typing .dot:nth-child(3){animation-delay:.24s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-6px);opacity:1}}

    /* Footer */
    .footer{padding:12px;background:var(--surface-2);border-top:1px solid var(--border)}
    .hint{
      font-size:11px;color:var(--brand);
      background:linear-gradient(135deg,rgba(116,186,88,.12),rgba(51,167,181,.10));
      border:1px solid var(--border);border-radius:12px;padding:8px 10px;text-align:center;font-weight:600;margin-bottom:10px
    }
    .row{display:flex;gap:10px;align-items:center}
    input[type="text"]{
      flex:1;padding:14px 16px;border:2px solid var(--border);border-radius:25px;
      font-size:16px;outline:none;background:var(--surface);color:var(--text);caret-color:var(--accent);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.06);
    }
    input[type="text"]::placeholder{color:var(--muted)}
    input[type="text"]:focus{border-color:var(--accent)}
    .send{
      width:52px;height:52px;border:none;border-radius:50%;cursor:pointer;color:#222;font-size:18px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow-soft)
    }
    .status{margin-top:6px;text-align:center;font-size:11px;color:var(--muted)}
    .pill{display:inline-block;padding:.5px 8px;border-radius:999px;background:rgba(25,169,116,.1);color:#19a974;font-weight:700;font-size:11px}

    /* Admin modal and panel */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;z-index:9998;
    }
    .modal .card{
      background:var(--surface);border:1px solid var(--border);border-radius:14px;
      padding:16px;min-width:280px;max-width:90%;box-shadow:var(--shadow);
    }
    .modal h4{font:700 14px "Nunito",sans-serif;margin-bottom:8px}
    .modal .row{margin-top:10px}
    .modal input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--surface-2);color:var(--text)}
    .modal .btn{margin-top:10px;width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:var(--surface-2)}
    .modal .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#222;border:none}

    .admin-panel{
      position:fixed;inset:auto 12px 12px 12px;background:var(--surface);
      border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);
      padding:12px;max-width:720px;display:none;z-index:9999;
    }
    .admin-panel h3{font:700 14px "Nunito",sans-serif;margin-bottom:8px}
    .admin-panel .row{gap:8px;margin-top:8px}
    .admin-panel textarea{width:100%;min-height:140px;border:1px solid var(--border);border-radius:8px;background:var(--surface-2);color:var(--text);padding:8px}
    .btn{border:1px solid var(--border);background:var(--surface-2);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#222;border:none}
    .k{font-family:ui-monospace,Consolas,monospace;background:rgba(0,0,0,.07);padding:1px 6px;border-radius:6px}
  </style>
</head>
<body>
  <main class="app" id="app">
    <header class="header">
      <div class="badge" aria-label="TASK Assistant">TASK Assistant</div>
      <button class="mic" id="micBtn" title="Voice input">🎙</button>
      <button class="theme" id="themeToggle" title="Toggle theme">☼</button>
    </header>

    <!-- Language prompt bar (manual override) -->
    <div class="langbar" id="langbar" role="group" aria-label="Language selection">
      <span class="lang-label">Language / Idioma / Lang:</span>
      <button class="lang-chip" data-lang="en" aria-label="Switch to English">EN</button>
      <button class="lang-chip" data-lang="es" aria-label="Cambiar a Español">ES</button>
      <button class="lang-chip" data-lang="ht" aria-label="Chanje pou Kreyòl">HT</button>
    </div>

    <!-- Quick links (labels will translate) -->
    <nav class="rail" id="top-rail">
      <a class="chip" id="chip-address" href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">📍 Address</a>
      <a class="chip" id="chip-jobs" href="https://bycell.co/ddmtq" target="_blank" rel="noopener">💼 Jobs</a>
      <a class="chip" id="chip-alerts" href="https://bycell.co/ddmtr" target="_blank" rel="noopener">🔔 Alerts</a>
      <a class="chip" id="chip-training" href="https://bycell.co/ddmtn" target="_blank" rel="noopener">🎓 Training</a>
      <a class="chip" id="chip-resume" href="https://bycell.co/ddmui" target="_blank" rel="noopener">📄 Resume</a>
      <a class="chip" id="chip-tips" href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">🎥 Interview Tips</a>
      <a class="chip" id="chip-resources" href="https://bycell.co/ddmua" target="_blank" rel="noopener">🧰 Resources</a>
    </nav>

    <!-- Chat area (ARIA live) -->
    <section class="chat" id="chat" role="log" aria-live="polite" aria-atomic="false"></section>

    <!-- Footer / Input -->
    <footer class="footer">
      <div class="hint" id="langHint">I speak English, Español & Kreyòl</div>
      <div class="row">
        <input id="box" type="text" placeholder="Type keywords: training, jobs, hours, address, bus…" autocomplete="off" aria-label="Type your message"/>
        <button class="send" id="send" aria-label="Send">➤</button>
      </div>
      <div class="status" id="status">⚠️ I can make mistakes — please double-check important info!</div>
      <div class="status">Admin: press <span class="k">Ctrl</span>+<span class="k">Alt</span>+<span class="k">A</span> (PIN required)</div>
    </footer>
  </main>

  <!-- Admin PIN Modal -->
  <div class="modal" id="pinModal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
    <div class="card">
      <h4 id="pinTitle">Enter admin PIN</h4>
      <p style="font-size:12px;color:var(--muted)">Shortcut: <span class="k">Ctrl</span>+<span class="k">Alt</span>+<span class="k">A</span></p>
      <div class="row">
        <input id="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="PIN" aria-label="Admin PIN"/>
      </div>
      <button class="btn primary" id="pinSubmit">Unlock</button>
      <button class="btn" id="pinCancel">Cancel</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel" id="adminPanel" aria-hidden="true" aria-label="Admin Panel">
    <h3>Admin • TASK Assistant</h3>
    <p class="note" style="font-size:12px;color:var(--muted);margin-bottom:6px">
      Export logs, see missed intents, or copy a usage summary. Close with Esc.
    </p>
    <div class="row">
      <button class="btn" id="exportCsv">Export CSV</button>
      <button class="btn" id="copySummary">Copy Summary</button>
      <button class="btn" id="clearLogs">Clear Logs</button>
      <button class="btn" id="closeAdmin" style="margin-left:auto">Close</button>
    </div>
    <div style="margin-top:10px">
      <strong style="font:700 13px Nunito, sans-serif">Missed / default queries</strong>
      <textarea id="missedBox" readonly></textarea>
    </div>
  </div>

  <script>
    /* ===========================
       CONSTANTS / STATE
    ============================*/
    const app  = document.getElementById('app');
    const chat = document.getElementById('chat');
    const box  = document.getElementById('box');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const themeToggle = document.getElementById('themeToggle');
    const langHint = document.getElementById('langHint');
    const langbar = document.getElementById('langbar');
    const pinModal = document.getElementById('pinModal');
    const pinInput = document.getElementById('pinInput');
    const pinSubmit = document.getElementById('pinSubmit');
    const pinCancel = document.getElementById('pinCancel');
    const adminPanel = document.getElementById('adminPanel');
    const exportCsvBtn = document.getElementById('exportCsv');
    const copySummaryBtn = document.getElementById('copySummary');
    const clearLogsBtn = document.getElementById('clearLogs');
    const missedBox = document.getElementById('missedBox');
    const micBtn = document.getElementById('micBtn');

    const chipAddress = document.getElementById('chip-address');
    const chipJobs = document.getElementById('chip-jobs');
    const chipAlerts = document.getElementById('chip-alerts');
    const chipTraining = document.getElementById('chip-training');
    const chipResume = document.getElementById('chip-resume');
    const chipTips = document.getElementById('chip-tips');
    const chipResources = document.getElementById('chip-resources');

    const PHONE_HTML = '<a href="tel:609-337-1624">(609) 337-1624</a>';
    const ADMIN_PIN = '1234';
    const THEME_KEY = 'task_theme';
    const LANG_KEY = 'task_lang';

    let currentLang = localStorage.getItem(LANG_KEY) || 'en';
    let lastIntent = null;
    const logs = [];
    const missed = [];

    /* ===========================
       THEME
    ============================*/
    function setTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem(THEME_KEY, t);
      themeToggle.textContent = t === 'dark' ? '☾' : '☼';
    }
    setTheme(localStorage.getItem(THEME_KEY) || 'light');
    themeToggle.addEventListener('click', ()=> setTheme(
      (document.documentElement.getAttribute('data-theme')==='dark') ? 'light' : 'dark'
    ));

    /* ===========================
       TRANSLATIONS
    ============================*/
    const L10N = {
      en: {
        welcome: '👋 Welcome! Use keywords like <em>training</em>, <em>jobs</em>, <em>hours</em>, <em>address</em>, or <em>bus</em>.',
        quick: 'Quick links:',
        simple: 'Try “training”, “jobs”, “hours”, “address”, “appointment”, or “bus”.',
        asked: 'You asked about',
        call: 'Call the Social Services Specialist at',
        during: 'During lunch (10:30 AM–1:00 PM).',
        view: 'Browse training & apply',
        jobs_open: 'Open positions (Mercer County)',
        alerts: 'Subscribe to alerts',
        resume: 'Resume help & templates',
        tips: 'Watch quick tips',
        mealHours: 'Meals: Lunch Mon–Fri 10:30a–1:00p • Dinner Mon–Thu 3:30–5:00p',
        address: '72½ Escher St, Trenton, NJ 08609',
        maps: 'Open Google Maps',
        bus: 'NJ Transit Trip Planner',
        more: 'Additional resources',
        allsvc: 'Full TASK services',
        thanks: '😊 You’re welcome!',
        sorry: 'I hear you — let me help fast:',
        talk: 'Call now',
        choices: 'Or pick one:',
        train: 'Training', jobs: 'Jobs', addr: 'Address',
        notFound: 'I might not have that yet. For more help, visit:',
        site_home: 'TASK website', site_services: 'What we do',
        say: 'You can also say: menu, help, language.',
        rail_address:'Address', rail_jobs:'Jobs', rail_alerts:'Alerts',
        rail_training:'Training', rail_resume:'Resume',
        rail_tips:'Interview Tips', rail_resources:'Resources'
      },
      es: {
        welcome: '👋 ¡Bienvenido! Usa palabras como <em>entrenamiento</em>, <em>empleos</em>, <em>horas</em>, <em>dirección</em> o <em>autobús</em>.',
        quick: 'Enlaces rápidos:',
        simple: 'Prueba “entrenamiento”, “empleos”, “horas”, “dirección”, “cita” o “autobús”.',
        asked: 'Preguntaste sobre',
        call: 'Llama al Especialista de Servicios Sociales al',
        during: 'Durante el almuerzo (10:30 AM–1:00 PM).',
        view: 'Ver entrenamientos y postular',
        jobs_open: 'Puestos disponibles (Condado de Mercer)',
        alerts: 'Suscribirme a alertas',
        resume: 'Ayuda con currículum y plantillas',
        tips: 'Ver consejos rápidos',
        mealHours: 'Comidas: Almuerzo Lun–Vie 10:30–1:00 • Cena Lun–Jue 3:30–5:00',
        address: '72½ Escher St, Trenton, NJ 08609',
        maps: 'Abrir Google Maps',
        bus: 'Planificador de viaje de NJ Transit',
        more: 'Recursos adicionales',
        allsvc: 'Todos los servicios de TASK',
        thanks: '😊 ¡Con gusto!',
        sorry: 'Entiendo — te ayudo rápido:',
        talk: 'Llamar ahora',
        choices: 'O elige:',
        train: 'Entrenamiento', jobs: 'Empleos', addr: 'Dirección',
        notFound: 'Puede que aún no tenga eso. Para más ayuda, visita:',
        site_home: 'Sitio de TASK', site_services: 'Qué hacemos',
        say: 'También puedes decir: menú, ayuda, idioma.',
        rail_address:'Dirección', rail_jobs:'Empleos', rail_alerts:'Alertas',
        rail_training:'Entrenamiento', rail_resume:'Currículum',
        rail_tips:'Consejos de entrevista', rail_resources:'Recursos'
      },
      ht: {
        welcome: '👋 Byenvini! Itilize mo tankou <em>fòmasyon</em>, <em>travay</em>, <em>lè</em>, <em>adrès</em>, oswa <em>otobis</em>.',
        quick: 'Lyen rapid:',
        simple: 'Eseye “fòmasyon”, “travay”, “lè”, “adrès”, “randevou”, oswa “otobis”.',
        asked: 'Ou te mande sou',
        call: 'Rele Espesyalis Sèvis Sosyal la nan',
        during: 'Pandan manje midi (10:30 AM–1:00 PM).',
        view: 'Gade fòmasyon & aplike',
        jobs_open: 'Travay ki disponib (Mercer County)',
        alerts: 'Abònman ak alèt',
        resume: 'Ede ak CV & modèl',
        tips: 'Gade konsèy rapid yo',
        mealHours: 'Manje: Madi–Vandredi 10:30–1:00 • Aswè Lendi–Jedi 3:30–5:00',
        address: '72½ Escher St, Trenton, NJ 08609',
        maps: 'Louvri Google Maps',
        bus: 'Planifikatè vwayaj NJ Transit',
        more: 'Resous adisyonèl',
        allsvc: 'Tout sèvis TASK yo',
        thanks: '😊 Pa gen pwoblèm!',
        sorry: 'M konprann — ann regle sa vit:',
        talk: 'Rele kounye a',
        choices: 'Oswa chwazi youn:',
        train: 'Fòmasyon', jobs: 'Travay', addr: 'Adrès',
        notFound: 'M pa gen enfòmasyon sa a kounye a. Pou plis èd, vizite:',
        site_home: 'Sit wèb TASK', site_services: 'Sa n ap fè',
        say: 'Ou ka di tou: meni, èd, lang.',
        rail_address:'Adrès', rail_jobs:'Travay', rail_alerts:'Alèt',
        rail_training:'Fòmasyon', rail_resume:'CV',
        rail_tips:'Konsèy entèvyou', rail_resources:'Resous'
      }
    };
    function t(key){ return L10N[currentLang][key]; }
    function setLang(lang){
      currentLang = (lang in L10N) ? lang : 'en';
      localStorage.setItem(LANG_KEY, currentLang);
      langHint.textContent =
        currentLang==='es' ? 'Hablo inglés, español y Kreyòl' :
        currentLang==='ht' ? 'M pale Angle, Panyòl & Kreyòl' :
        'I speak English, Español & Kreyòl';
      // Update chip labels
      chipAddress.textContent = '📍 ' + t('rail_address');
      chipJobs.textContent = '💼 ' + t('rail_jobs');
      chipAlerts.textContent = '🔔 ' + t('rail_alerts');
      chipTraining.textContent = '🎓 ' + t('rail_training');
      chipResume.textContent = '📄 ' + t('rail_resume');
      chipTips.textContent = '🎥 ' + t('rail_tips');
      chipResources.textContent = '🧰 ' + t('rail_resources');
      // Update voice language if active later
      if(rec) rec.lang = currentLang === 'es' ? 'es-ES' : (currentLang==='ht' ? 'ht-HT' : 'en-US');
    }
    setLang(currentLang);

    langbar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lang-chip'); if(!btn) return;
      setLang(btn.dataset.lang);
      addBot(`🌐 Language set to <strong>${btn.dataset.lang.toUpperCase()}</strong>.`);
    });

    /* ===========================
       CHAT HELPERS
    ============================*/
    function addUser(text){
      const el = document.createElement('div');
      el.className = 'bubble user';
      el.textContent = text;
      chat.appendChild(el);
      el.scrollIntoView({behavior:'smooth',block:'end'});
    }
    function addBot(html){
      const el = document.createElement('div');
      el.className = 'bubble bot';
      el.innerHTML = html;
      chat.appendChild(el);
      el.scrollIntoView({behavior:'smooth',block:'end'});
    }
    function typing(on=true){
      const id='typing';
      if(on){
        const el=document.createElement('div');
        el.id=id; el.className='bubble bot';
        el.innerHTML = `<div class="typing" aria-label="Assistant is typing">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </div>`;
        chat.appendChild(el);
      }else{
        const t=document.getElementById(id); if(t) t.remove();
      }
      chat.scrollTop = chat.scrollHeight;
    }
    function logEvent(text, intent, resolved=true){
      const row={ts:new Date().toISOString(), lang:currentLang, text, intent, resolved};
      logs.push(row);
      if(!resolved || intent==='default'){
        missed.push(`${row.ts} • [${row.lang}] ${row.text}`);
        missedBox.value = missed.join('\n');
      }
    }
    function toCSV(rows){
      if(!rows.length) return '';
      const headers = Object.keys(rows[0]);
      const esc = v => `"${String(v).replace(/"/g,'""')}"`;
      return [headers.map(esc).join(','), ...rows.map(r=>headers.map(h=>esc(r[h]??'')).join(','))].join('\n');
    }

    /* ===========================
       LANGUAGE DETECT (auto)
    ============================*/
    function detectLang(text){
      const t = text.toLowerCase();
      const es = /(hola|necesito|trabaj|emple|d[oó]nde|horari|cita|servici|comida|entrenam|tel[eé]fono|direcci[oó]n|curso|cursos|seguridad|licencia)/.test(t);
      const ht = /(bonjou|bonswa|mwen|bezwen|travay|kote|manje|krey[oò]l|telef[oò]n|adr[eè]s|randevou|s[eè]vis|f[òo]masyon|lisans)/.test(t);
      return es ? 'es' : (ht ? 'ht' : 'en');
    }

    /* ===========================
       INTENT: KEYWORDS + FUZZY
    ============================*/
    function lev(a,b){
      a=a.toLowerCase(); b=b.toLowerCase();
      const m=a.length,n=b.length; const dp=Array.from({length:m+1},(_,i)=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }
    function fuzzyMatch(word, candidates){
      let best = 99;
      for(const k of candidates){ best = Math.min(best, lev(word,k)); if(best===0) break; }
      return best <= 2;
    }

    // Expanded synonyms (EN/ES/HT + common misspellings/variants)
    const SYN = {
      trainings: [
        'training','trainings','program','programs','class','classes','course','courses',
        'certificate','certification','license','licence','licensee','sora','security license','security guard',
        'culinary','academy','forklift','food handler','servsafe',
        // ES
        'entrenamiento','entrenamientos','curso','cursos','certificado','certificación','licencia','licencia de seguridad','sora',
        // HT
        'fòmasyon','fomasyon','lisans','sekirite','sora','lekòl kwizin','forklift'
      ],
      jobs: [
        'job','jobs','work','employment','hiring','hire','opening','openings','apply','application','position','positions','career',
        // ES
        'empleo','empleos','trabajo','trabajar','aplicar','postular','vacante','vacantes',
        // HT
        'travay','anbochaj','pozisyon','aplika'
      ],
      alerts: ['alert','alerts','notify','notification','subscribe','updates','signup',
        'alertas','suscribirme','notificación','notificaciones',
        'alèt','abònman','notifikasyon'
      ],
      resume: [
        'resume','cv','curriculum','currículum','cover','cover letter','template','templates','format',
        'curriculo','hoja de vida','plantilla','modelo',
        'cv modèl','modèl','modèl cv'
      ],
      interview: [
        'interview','interviews','tips','mock','practice','practice interview',
        'entrevista','entrevistas','consejos','práctica',
        'entèvyou','konsèy','pratik'
      ],
      appointments: [
        'appointment','appointments','schedule','book','meeting','register','sign','rsvp','call me','call back',
        'cita','citas','programar','agendar','registrar','inscribirme','llamada',
        'randevou','randevou a','pwograme','enskri','rele'
      ],
      hours: [
        'hour','hours','time','when','open','close','opening','closing','lunch','dinner','meal','food',
        'hora','horario','abren','cierran','almuerzo','cena','comida',
        'lè','lè yo louvri','lè yo fèmen','manje','manje midi','manje aswè'
      ],
      meals: [ // alias to hours
        'meal','meals','food','kitchen','soup','eat','dining',
        'comida','comidas','cocina','comedor',
        'manje','kwizin'
      ],
      location: [
        'where','address','location','directions','map','parking','drive','gps',
        'donde','dirección','ubicación','mapa','estacionamiento','parqueo','ruta',
        'kote','adrès','kat','pakin','direksyon'
      ],
      transit: [
        'bus','nj','transit','route','routes','fare','ticket','train','transport','planner','schedule',
        'autobús','bus','rutas','billete','tarifa','tren','transporte','horario',
        'otobis','otobys','bous','chemen','tikè','pri','tren','orè'
      ],
      computer_lab: [
        'computer','internet','wifi','lab','email','application','online','printer','print','scan',
        'computadora','internet','laboratorio','correo','imprimir','escanear',
        'odinatè','entènèt','lab','enprime','eskane'
      ],
      resources: [
        'resource','resources','assistance','support','services','benefits','snap','tanf','welfare','housing','shelter','rent','utilities','legal','expungement','id','birth certificate','clothes','mental health','wellness','therapy','counseling',
        'recursos','asistencia','apoyo','beneficios','vivienda','albergue','renta','utilidades','legal','expurgación','expungement','identificación','certificado de nacimiento','ropa','salud mental','terapia','orientación',
        'resous','asistans','sipò','benefis','lojman','abri','lwaye','dlo','kouran','legal','efasman','idantite','sètifika nesans','rad','sante mantal','terapi','konsèy'
      ],
      greeting: ['hi','hello','hey','hola','bonjou','bonswa','salut'],
      thanks: ['thanks','thank','gracias','mesi','thank you','ty','thx'],
      profanity: ['fuck','shit','bitch','asshole','bastard','dick','pussy','cunt','motherfucker','bullshit','wtf','coño','mierda']
    };

    function classify(input){
      const raw = input;
      const t = input.toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').trim();
      if(!t) return 'default';

      // Manual commands
      if(/^\/lang\s+(en|es|ht)\b/.test(t)){ setLang(t.match(/^\/lang\s+(en|es|ht)\b/)[1]); return 'greeting'; }
      if(/^(menu|help|ayuda|ede|aide)\b/.test(t)) return 'greeting';

      // Language auto-switch
      const guess = detectLang(t);
      if(guess !== currentLang && !/\/lang/.test(t)) setLang(guess);

      // quick includes
      for(const key of Object.keys(SYN)){
        for(const kw of SYN[key]){
          if(t.includes(kw)) return key;
        }
      }
      // fuzzy tokens
      const tokens = t.split(/\s+/).slice(0,8);
      for(const key of Object.keys(SYN)){
        if(tokens.some(tok=>fuzzyMatch(tok, SYN[key]))) return key;
      }

      // fallback context
      if(/(when|what\s*time|hour|hours|dinner|lunch|open|close|horas|hora|horario|lè|manje)/.test(t)) return 'hours';
      if(/(where|address|map|kote|adr[eè]s|direcci[oó]n|parking|parqueo)/.test(t)) return 'location';

      return 'default';
    }

    /* ===========================
       RESPONSES
    ============================*/
    function respond(intentKey){
      const showHours = () => `<strong>🕒 ${t('asked')} hours.</strong><br><br>${t('mealHours')}`;
      const M = {
        trainings: () => `<strong>🎓 ${t('asked')} training.</strong><br><br>
          • Emilio Culinary Academy (10-week)<br>
          • SORA Security Certification<br>
          • Forklift Certification<br><br>
          <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">${t('view')}</a><br>
          ${t('call')} ${PHONE_HTML}. ${t('during')}.`,
        jobs: () => `<strong>💼 ${t('asked')} jobs.</strong><br><br>
          <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">${t('jobs_open')}</a><br>
          <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">${t('alerts')}</a><br><br>
          ${t('call')} ${PHONE_HTML}. ${t('during')}.`,
        alerts: () => `<strong>🔔 ${t('asked')} alerts.</strong><br><br>
          <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">${t('alerts')}</a>`,
        resume: () => `<strong>📄 ${t('asked')} resume help.</strong><br><br>
          <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">${t('resume')}</a><br><br>
          ${t('call')} ${PHONE_HTML}. ${t('during')}.`,
        interview: () => `<strong>🎥 ${t('asked')} interview tips.</strong><br><br>
          <a href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">${t('tips')}</a>`,
        appointments: () => `<strong>📅 ${t('asked')} an appointment.</strong><br><br>
          ${t('call')} ${PHONE_HTML}. ${t('during')}.`,
        hours: showHours,
        meals: showHours,
        location: () => `<strong>📍 ${t('asked')} our location.</strong><br><br>
          ${t('address')}<br>
          <a href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">${t('maps')}</a>`,
        transit: () => `<strong>🚌 ${t('asked')} transit.</strong><br><br>
          <a href="https://www.njtransit.com/trip-planner-to" target="_blank" rel="noopener">${t('bus')}</a> • 1-973-275-5555<br>
          Destination: 72½ Escher St, Trenton.`,
        computer_lab: () => `<strong>💻 ${t('asked')} the computer lab.</strong><br><br>
          Open during meal hours. Free internet, printing & job applications.`,
        resources: () => `<strong>🧰 ${t('asked')} resources.</strong><br><br>
          <a href="https://bycell.co/ddmua" target="_blank" rel="noopener">${t('more')}</a><br>
          <a href="https://trentonsoupkitchen.org/what-we-do/" target="_blank" rel="noopener">${t('allsvc')}</a>`,
        profanity: () => `<strong>🙏 ${t('sorry')}</strong><br><br>
          ${t('talk')}: ${PHONE_HTML}<br><br>
          ${t('choices')} <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">${t('train')}</a> ·
          <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">${t('jobs')}</a> ·
          <a href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">${t('addr')}</a>`,
        greeting: () => `👋 ${t('simple')}<br><span class="pill">${t('say')}</span>`,
        thanks: () => `${t('thanks')}`,
        default: () => `<strong>🔗 ${t('notFound')}</strong><br>
          <a href="https://trentonsoupkitchen.org/" target="_blank" rel="noopener">${t('site_home')}</a> •
          <a href="https://trentonsoupkitchen.org/what-we-do/" target="_blank" rel="noopener">${t('site_services')}</a>`
      };
      return (M[intentKey] || M.default)();
    }

    /* ===========================
       SEND / FLOW
    ============================*/
    function handle(text){
      if(!text) return;
      addUser(text);

      statusEl.textContent = '🤖 Thinking…';
      typing(true);

      const maybe = detectLang(text);
      if(maybe !== currentLang) setLang(maybe);

      let key = classify(text);
      if(/(useless|stupid|idiot|annoy|angry|mad|frustrat)/i.test(text)) key = 'profanity';
      if(/thank/i.test(text)) key = 'thanks';

      if(key !== 'default'){ lastIntent = key; }

      setTimeout(()=>{
        typing(false);
        addBot(respond(key));
        statusEl.textContent = '✅ Answered!';
        setTimeout(()=> statusEl.textContent = '⚠️ I can make mistakes — please double-check important info!', 1200);
        logEvent(text, key, key!=='default');
      }, 260);
    }

    function send(){
      const text = (box.value || '').trim();
      if(!text) return;
      box.value = ''; box.focus();
      handle(text);
    }

    // Initial welcome
    addBot(`🟡 <strong>${t('welcome')}</strong><br><br>
            ${t('quick')} <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">${t('rail_training')}</a> •
            <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">${t('rail_jobs')}</a> •
            <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">${t('rail_alerts')}</a>`);

    // Events
    sendBtn.addEventListener('click', send);
    box.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); } });

    /* ===========================
       ADMIN: Ctrl + Alt + A + PIN
    ============================*/
    function openPinModal(){
      pinModal.style.display='flex';
      pinInput.value='';
      pinInput.focus();
    }
    function closePinModal(){ pinModal.style.display='none'; }
    function openAdmin(){
      adminPanel.style.display='block';
      adminPanel.setAttribute('aria-hidden','false');
    }
    function closeAdmin(){
      adminPanel.style.display='none';
      adminPanel.setAttribute('aria-hidden','true');
    }

    document.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.altKey && e.key.toLowerCase()==='a'){
        e.preventDefault(); openPinModal();
      }
      if(e.key==='Escape'){
        if(pinModal.style.display==='flex') closePinModal();
        else if(adminPanel.style.display==='block') closeAdmin();
      }
    });
    pinSubmit.addEventListener('click', ()=>{
      if(pinInput.value.trim()===ADMIN_PIN){
        closePinModal(); openAdmin();
      }else{
        pinInput.value=''; pinInput.focus(); alert('Incorrect PIN');
      }
    });
    pinCancel.addEventListener('click', closePinModal);

    document.getElementById('closeAdmin').addEventListener('click', closeAdmin);

    exportCsvBtn.addEventListener('click', ()=>{
      const csv = toCSV(logs);
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `task-assistant-logs-${Date.now()}.csv`;
      a.click(); URL.revokeObjectURL(url);
    });

    copySummaryBtn.addEventListener('click', ()=>{
      const counts = logs.reduce((acc,r)=>{ acc[r.intent]=(acc[r.intent]||0)+1; return acc; },{});
      const lines = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`• ${k}: ${v}`).join('\n');
      const summary =
`TASK Assistant Summary
Total messages: ${logs.length}
Top intents:
${lines||'(no data)'}
Missed: ${missed.length}

Missed examples:
${missed.slice(0,15).map(x=>'– '+x).join('\n')}`;
      navigator.clipboard.writeText(summary).then(()=>alert('Summary copied to clipboard.'));
    });

    clearLogsBtn.addEventListener('click', ()=>{
      if(!confirm('Clear all session logs?')) return;
      logs.length = 0; missed.length = 0; missedBox.value = '';
      alert('Logs cleared for this session.');
    });

    /* ===========================
       VOICE INPUT (optional)
    ============================*/
    let recognizing = false;
    let rec = null;
    (function setupVoice(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ micBtn.style.display='none'; return; }
      rec = new SR();
      rec.lang = currentLang === 'es' ? 'es-ES' : (currentLang==='ht' ? 'ht-HT' : 'en-US');
      rec.interimResults = false; rec.maxAlternatives = 1;
      rec.onresult = (e)=>{ const transcript = e.results[0][0].transcript; box.value = transcript; handle(transcript); };
      rec.onend = ()=>{ recognizing=false; micBtn.textContent='🎙'; };
      rec.onerror = ()=>{ recognizing=false; micBtn.textContent='🎙'; };
    })();

    micBtn.addEventListener('click', ()=>{
      if(!rec) return;
      if(recognizing){ rec.stop(); recognizing=false; micBtn.textContent='🎙'; return; }
      try{
        rec.lang = currentLang === 'es' ? 'es-ES' : (currentLang==='ht' ? 'ht-HT' : 'en-US');
        rec.start(); recognizing=true; micBtn.textContent='⏺';
      }catch(e){ recognizing=false; micBtn.textContent='🎙'; }
    });
  </script>
</body>
</html>
