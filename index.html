<script>
  /* ---------- Helpers: language + intent ---------- */
  function detectLang(t){
    t = t.toLowerCase();
    const es = /hola|necesito|trabajo|empleo|donde|cuando|hora|horas|español|tel[eé]fono|direcci[oó]n|cita|servicios|comida/.test(t);
    const ht = /bonjou|bonswa|mwen|bezwen|travay|kote|ede|manje|krey[oò]l|telef[oò]n|adr[eè]s|randevou|s[eè]vis/.test(t);
    return es ? 'es' : (ht ? 'ht' : 'en');
  }

  function classifyIntent(text){
    const t = (' ' + text.toLowerCase() + ' ').replace(/[^\p{L}\p{N}\s]/gu,' ');

    const bag = {
      trainings: /(training|trainings|program|programs|class|classes|course|courses|certification|culinary|emilio|sora|forklift|academy|apprenticeship)\b/,
      jobs: /(job|jobs|work|employment|hiring|hire|opening|openings|apply|application|position|positions|indeed)\b|empleo|trabajo|travay/,
      alerts: /(alert|alerts|notify|notification|subscribe|text alert|updates)/,
      resume: /(resume|curriculum|currículum|cv|cover\s*letter)/,
      interview: /(interview|interview\s*tips|mock\s*interview|practice\s*interview)/,
      resources: /(resource|resources|help|assistance|support\s*services|services\s*list)/,
      appointments: /(appointment|schedule|book|meeting|register|sign\s*up|rsvp|cita|programar|randevou)/,
      hours: /(hour|hours|time|when|open|close|lunch|dinner|meal|eat|food|hora|almuerzo|cena|manje)/,
      location: /(where|address|location|directions|map|parking|d[oó]nde|direcci[oó]n|ubicaci[oó]n|kote|adr[eè]s)/,
      transit: /(bus|nj\s*transit|route|fare|ticket|train|transport|planner)/,
      computer_lab: /(computer|internet|wifi|lab|email|application\s*online)/,
      support: /(case\s*management|housing|benefits|id|veterans|domestic\s*violence|recovery|peer)/,
      greeting: /(hi|hello|hey|hola|bonjou|buenas)/,
      thanks: /(thanks|thank you|gracias|mesi)/
    };

    for (const [k, rx] of Object.entries(bag)) {
      if (rx.test(t)) return k;
    }
    return 'default';
  }

  /* ---------- Router: returns ONE focused answer ---------- */
  function getResponse(input){
    const lang = detectLang(input || '');
    const intent = classifyIntent(input || '');

    // Small i18n helpers
    const L = {
      call: lang==='es' ? 'Llama' : lang==='ht' ? 'Rele' : 'Call',
      duringLunch: lang==='es' ? 'Durante el almuerzo (10:30 AM–1:00 PM)'
                  : lang==='ht' ? 'Lè manje midi (10:30 AM–1:00 PM)'
                  : 'During lunch (10:30 AM–1:00 PM)',
      map: lang==='es' ? 'Google Maps' : lang==='ht' ? 'Google Maps' : 'Google Maps',
      phone: '<a href="tel:609-337-1624">(609) 337-1624</a>',
      asked: lang==='es' ? 'Me preguntas sobre' : lang==='ht' ? 'W ap mande sou' : 'You asked about',
      suggestions: lang==='es' ? 'Sugerencias' : lang==='ht' ? 'Sijesyon' : 'Suggestions',
      trainings: lang==='es' ? 'entrenamientos' : lang==='ht' ? 'fòmasyon' : 'training',
      jobs: lang==='es' ? 'empleos' : lang==='ht' ? 'travay' : 'jobs'
    };

    // Builders for each intent
    const R = {
      trainings: () => (
        `<strong>🎓 ${L.asked} ${L.trainings}.</strong><br><br>
         • Emilio Culinary Academy (10-week)<br>
         • SORA Security Certification<br>
         • Forklift Certification<br><br>
         <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Browse training & apply</a><br>
         ${L.call} the Social Services Specialist: ${L.phone}. ${L.duringLunch}.<br><br>
         <em>${L.suggestions}:</em> <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">See ${L.jobs}</a> •
         <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume help</a>`
      ),

      jobs: () => (
        `<strong>💼 ${L.asked} ${L.jobs}.</strong><br><br>
         <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Open positions (Mercer County)</a><br>
         <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Get job alerts by text</a><br><br>
         Need help applying? ${L.call}: ${L.phone}. ${L.duringLunch}.<br><br>
         <em>${L.suggestions}:</em> <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume help</a> •
         <a href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">Interview tips</a>`
      ),

      alerts: () => (
        `<strong>🔔 ${L.asked} job alerts.</strong><br><br>
         <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Subscribe to job alerts</a><br>
         You can unsubscribe any time.`
      ),

      resume: () => (
        `<strong>📄 ${L.asked} resume help.</strong><br><br>
         <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume help & templates</a><br><br>
         Want 1-on-1 help? ${L.call}: ${L.phone}. ${L.duringLunch}.`
      ),

      interview: () => (
        `<strong>🎥 ${L.asked} interview tips.</strong><br><br>
         <a href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">Watch quick interview tips</a><br><br>
         Practice with us: ${L.call} ${L.phone}.`
      ),

      appointments: () => (
        `<strong>📅 ${L.asked} an employment appointment.</strong><br><br>
         ${L.call} the Social Services Specialist at ${L.phone}. ${L.duringLunch}.<br>
         Or <a href="https://bycell.co/ddmul" target="_blank" rel="noopener">register online</a>.`
      ),

      hours: () => (
        `<strong>🕒 ${L.asked} our hours.</strong><br><br>
         Lunch: Mon–Fri 10:30 AM–1:00 PM • Dinner: Mon–Thu 3:30–5:00 PM<br>
         Employment appointments are scheduled ${L.duringLunch.toLowerCase()}.`
      ),

      location: () => (
        `<strong>📍 ${L.asked} our location.</strong><br><br>
         72½ Escher St, Trenton, NJ 08609<br>
         <a href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">Open ${L.map}</a><br><br>
         Appointments: ${L.phone}.`
      ),

      transit: () => (
        `<strong>🚌 ${L.asked} transit.</strong><br><br>
         <a href="https://www.njtransit.com/trip-planner-to" target="_blank" rel="noopener">NJ Transit Trip Planner</a> • 1-973-275-5555<br>
         Destination: 72½ Escher St, Trenton.`
      ),

      computer_lab: () => (
        `<strong>💻 ${L.asked} the computer lab.</strong><br><br>
         Open during meal hours (see hours). Free internet & job applications.<br>
         <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume help</a>`
      ),

      resources: () => (
        `<strong>🧰 ${L.asked} resources/services.</strong><br><br>
         <a href="https://bycell.co/ddmua" target="_blank" rel="noopener">Additional resources</a><br>
         <a href="https://trentonsoupkitchen.org/what-we-do/" target="_blank" rel="noopener">Full TASK services</a>`
      ),

      support: () => (
        `<strong>🤝 ${L.asked} support services.</strong><br><br>
         Case management, housing/ID help, DV assistance, peer recovery, veterans support.<br>
         ${L.call}: ${L.phone}.`
      ),

      greeting: () => (
        `<strong>👋 Hi! I'm the TASK Assistant.</strong><br>
         Ask me about trainings, jobs, appointments, hours, directions or transit.<br><br>
         <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a> •
         <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Jobs</a> •
         <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume</a>`
      ),

      thanks: () => `<strong>😊 You’re welcome!</strong> Anything else I can help with?`,

      default: () => (
        `<strong>💬 I’ll keep it simple.</strong><br>
         Tell me “training”, “jobs”, “hours”, “address”, “bus”, or “appointment”.<br><br>
         Quick links: <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a> •
         <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Jobs</a> •
         <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Job alerts</a>`
      )
    };

    return (R[intent] || R.default)();
  }
</script>
